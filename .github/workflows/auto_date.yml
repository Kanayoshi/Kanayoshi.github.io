name: Auto Update Date Field for Staged Markdown Files

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main  # 適宜ブランチ名を変更

jobs:
  update-date-field:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Update date in staged Markdown files only
        run: |
          # JST時間の現在日時を取得
          export TZ=Asia/Tokyo
          current_date=$(date +"%Y-%m-%d %H:%M:%S")

          # ローカルの変更を確認
          changed_files=$(git status --porcelain | grep '^ M' | awk '{print $2}' | grep '\.md$' || true)

          echo "対象ファイル: $added_files"

          for file in $added_files; do
            if [ -f "$file" ] && grep -q '^date: ' "$file"; then
              echo "Updating date in: $file"
              sed -i "s/^date: .*/date: $current_date/" "$file"
              git add "$file"
            fi
          done

      - name: Commit and push changes
        run: |
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update date field for added Markdown files"
            git push
          fi
